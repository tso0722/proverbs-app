<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë§ì”€ ê¸°ë¡ ì•±</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #fafafa;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.screen {
  display: none;
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  min-height: 0;
  flex-direction: column;
}

.screen.active {
  display: flex;
}

h2 {
  text-align: center;
  margin-bottom: 10px;
}

button {
  border: none;
  border-radius: 8px;
  padding: 10px;
  font-size: 15px;
  background: #f2f2f2;
}

button:active {
  background: #ffe08c;
}

.nav {
  display: flex;
  border-top: 1px solid #ddd;
}

.nav button {
  flex: 1;
  padding: 12px;
  font-size: 18px;
}

/* ===== í™”ë©´ 1 ===== */
.member-list {
  list-style: none;
  padding: 0;
}

.member-list li {
  padding: 10px;
  background: white;
  border-radius: 8px;
  margin-bottom: 6px;
}

.member-btns {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

/* ===== í™”ë©´ 2 ===== */
.top {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-bottom: 10px;
  flex-shrink: 0;
}

#verseList {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
}

.verse {
  padding: 10px;
  background: white;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
}

.verse.selected {
  background: #ffe08c;
}

/* ===== í™”ë©´ 3 ===== */
textarea {
  width: 100%;
  height: calc(100vh - 200px);
  border-radius: 8px;
  padding: 10px;
  font-size: 15px;
}
</style>
</head>

<body>

<!-- ğŸ‘¤ í™”ë©´ 1 -->
<div id="members" class="screen active">
  <h2>ì°¸ì—¬ ì¸ì›</h2>
  <ul id="memberList" class="member-list"></ul>

  <div class="member-btns" style="margin-top:auto;flex-shrink:0">
    <button onclick="addMember()">â• ì¶”ê°€</button>
    <button onclick="editMember()">âœï¸ ìˆ˜ì •</button>
    <button onclick="moveUp()">â¬†</button>
    <button onclick="deleteMember()">âŒ ì‚­ì œ</button>
    <button onclick="saveMembers()">ğŸ’¾ ì €ì¥</button>
    <button onclick="moveDown()">â¬‡</button>

  </div>
</div>
<!-- ğŸ“– í™”ë©´ 2 -->
<div id="verses" class="screen">
  
  <div class="top">
    <span id="todayDate" style="margin-right:10px; font-weight:bold;"></span>
    <button 
    onclick="prevChapter()" 
    style="font-size:18px; padding:10px 15px; height:50px; width:50px;">
    â¬…
</button>
    <input id="chapterInput" value="1" style="width:50px;text-align:center">
    <span>ì¥</span>
    <button 
    onclick="nextChapter()" 
    style="font-size:18px; padding:10px 15px; height:50px; width:50px;">
    â¡
</button>

  </div>

  <h2 id="chapterTitle"></h2>
  <div id="verseList"></div>

  <button style="width:100%;margin-top:10px;flex-shrink:0" onclick="copyVerses()">ğŸ“‹ ë³µì‚¬</button>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸: ì˜¤ëŠ˜ ë‚ ì§œ -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // 0~11ì´ë¯€ë¡œ +1
    const day = String(today.getDate()).padStart(2, '0');

    // yyyy-mm-dd í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
    document.getElementById("todayDate").textContent = `${year}-${month}-${day}`;

    // chapterë¥¼ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì´ˆê¸°í™” (ì˜ˆ: ì¼(day) ê¸°ì¤€)
    const chapterInput = document.getElementById("chapterInput");
    chapterInput.value = day;
    chapter = Number(day); // JS ë³€ìˆ˜ chapterì™€ ë™ê¸°í™”
    loadVerses();
  });
</script>

<!-- ğŸ“ í™”ë©´ 3 -->
<div id="stats" class="screen">
  <h2>ê¸°ë¡</h2>
  <textarea id="statsText"></textarea>

  <div style="display:flex;gap:8px;margin-top:8px">
    <button onclick="copyAll()" style="flex: 1;">ğŸ“„ ì „ì²´ ë³µì‚¬</button>
    <button onclick="pasteText()" style="flex: 1;">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</button>
    <button onclick="undoText()" style="flex: 1;">â†©ï¸ ì‹¤í–‰ì·¨ì†Œ</button>
    <button onclick="shareText()" style="flex: 1;">ğŸ”—ê³µìœ í•˜ê¸°</button>
  </div>
</div>

<!-- í•˜ë‹¨ íƒ­ -->
<div class="nav">
  <button onclick="show('members')">ğŸ‘¤</button>
  <button onclick="show('verses')">ğŸ“–</button>
  <button onclick="show('stats')">ğŸ“</button>
</div>

<script>
/* ===== ê³µí†µ ===== */
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ===== ë°ì´í„° ===== */
let members = JSON.parse(localStorage.getItem("members")) || [];
let selectedIndex = null;


/* ===== í™”ë©´ 1 ===== */
function renderMembers() {
  const ul = document.getElementById("memberList");
  ul.innerHTML = "";
  members.forEach((m,i)=>{
    const li = document.createElement("li");
    li.textContent = m;
    li.onclick = ()=> selectedIndex=i;
    ul.appendChild(li);
  });
}
renderMembers();

function addMember() {
  const n = prompt("ì´ë¦„ ì…ë ¥");
  if(n) members.push(n);
  renderMembers();
}

function editMember() {
  if(selectedIndex==null) return;
  const n = prompt("ìƒˆ ì´ë¦„", members[selectedIndex]);
  if(n) members[selectedIndex]=n;
  renderMembers();
}

function deleteMember() {
  if(selectedIndex==null) return;
  members.splice(selectedIndex,1);
  selectedIndex=null;
  renderMembers();
}

function moveUp() {
  if(selectedIndex>0){
    [members[selectedIndex-1],members[selectedIndex]]=[members[selectedIndex],members[selectedIndex-1]];
    selectedIndex--;
    renderMembers();
  }
}

function moveDown() {
  if(selectedIndex < members.length-1){
    [members[selectedIndex+1],members[selectedIndex]]=[members[selectedIndex],members[selectedIndex+1]];
    selectedIndex++;
    renderMembers();
  }
}

function saveMembers() {
  localStorage.setItem("members",JSON.stringify(members));
  alert("ì €ì¥ ì™„ë£Œ");
  updateStats();
}

/* ===== í™”ë©´ 2 ===== */
const today = new Date();
let chapter = today.getDate(); // ì˜¤ëŠ˜ ë‚ ì§œ(day)ë¥¼ ì¥(chapter)ìœ¼ë¡œ ì‚¬ìš©
let selectedVerses = [];
let proverbs = {};

// APIì—ì„œ json ë¶ˆëŸ¬ì˜¤ê¸°
fetch("/api/proverbs")
  .then(res => res.json())
  .then(data => {
    proverbs = data;
    loadVerses();
  })
  .catch(err => console.error("json ë¡œë“œ ì‹¤íŒ¨:", err));

function loadVerses() {
  const list = document.getElementById("verseList");
  list.innerHTML="";
  document.getElementById("chapterTitle").textContent=`ì ì–¸ ${chapter}ì¥`;
  document.getElementById("chapterInput").value=chapter;

  if(!proverbs[chapter]) return;
  
  for(let v in proverbs[chapter]){
    const d=document.createElement("div");
    d.className="verse";
    d.textContent=`${v}ì ˆ${proverbs[chapter][v]}`;
    d.onclick=()=>{
      d.classList.toggle("selected");
      const key = `${chapter}:${v}`;
      if(selectedVerses.includes(key)) {
        selectedVerses = selectedVerses.filter(item => item !== key);
      } else {
        selectedVerses.push(key);
      }
    }
    list.appendChild(d);
  }
}

function prevChapter(){ if(chapter>1){chapter--;loadVerses();}}
function nextChapter(){ if(chapter<31){chapter++;loadVerses();}}

function copyVerses(){
  if(!selectedVerses.length) return showToast("ì„ íƒ ì—†ìŒ");
  
  let result = [];
  selectedVerses.sort((a, b) => {
    const [ch1, v1] = a.split(":").map(Number);
    const [ch2, v2] = b.split(":").map(Number);
    if(ch1 !== ch2) return ch1 - ch2;
    return v1 - v2;
  }).forEach(key => {
    const [ch, v] = key.split(":");
    result.push(`${ch}:${v} ${proverbs[ch][v]}`);
  });
  
  navigator.clipboard.writeText(result.join("\n"));
}



/* ===== í™”ë©´ 3 ===== */
let undoStack=[];
const stats=document.getElementById("statsText");

function updateStats(){
  stats.value = members.join("\n\n\n");
  saveUndo();
}

function saveUndo(){
  undoStack.push(stats.value);
}

stats.addEventListener("input",saveUndo);

function undoText(){
  if(undoStack.length>1){
    undoStack.pop();
    stats.value=undoStack[undoStack.length-1];
  }
}

async function pasteText() {
  const text = await navigator.clipboard.readText();
  const textarea = document.getElementById("statsText");
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;

  // ëª¨ë“  ì¤„ë°”ê¿ˆ ì œê±°
  const cleanText = text.replace(/[\r\n]+/g, " ").trim(); // \r\n, \n ëª¨ë‘ ì²˜ë¦¬
  const before = textarea.value.substring(0, start);
  const after = textarea.value.substring(end).replace(/^\s+/, ""); // ë¶™ì—¬ë„£ê¸° í›„ ì• ê³µë°± ì œê±°
  textarea.value = before + "ì " + cleanText.trimStart() + after;

  // ì„ íƒ í›„ ì»¤ì„œ ìœ„ì¹˜
  textarea.selectionStart = textarea.selectionEnd = start + cleanText.length;

  saveUndo();
}

function shareText() {
  if (navigator.share) {
    navigator.share({
      title: 'ë§ì”€ ê¸°ë¡',
      text: stats.value,
    }).catch(err => console.error("ê³µìœ  ì‹¤íŒ¨:", err));
  } else {
    alert("ê³µìœ  ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.");
  }
}

function copyAll(){
  navigator.clipboard.writeText(stats.value);
}

updateStats();
</script>
</body>
</html>
